<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Your Wish</title>
    <link rel="stylesheet" href="css/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container" style="max-width: 900px;">
        <h1>Share Your Wish</h1>
        <p>Share the wishes you want to store in the jar or pick a random one from everyone else. Please keep submissions polite and compliantâ€”avoid profanity, offensive content, or anything inappropriate.</p>

        <div class="button-group" style="margin-top: 1rem;">
            <button id="shareViewBtn">Share your wish</button>
            <button id="readViewBtn">Read a random wish</button>
        </div>

        <section id="shareSection" class="card" style="display: none;">
            <h2>Send a wish</h2>
            <p>Write your message and add it to the wish jar.</p>
            <div class="form-group">
                <label for="wishInput">Your wish</label>
                <textarea id="wishInput" rows="5" placeholder="Write your wish here"></textarea>
            </div>
            <button id="submitWishBtn">Send</button>
            <p id="shareFeedback" class="footer-text" style="text-align: left; margin-top: 1rem;"></p>
        </section>

        <section id="readSection" class="card" style="display: none;">
            <h2>Read a random wish</h2>
            <p>Press the button to pick a wish from those submitted.</p>
            <button id="randomWishBtn">Pick a wish</button>
            <div id="randomWishDisplay" class="card" style="display: none; margin-top: 1rem; background-color: #f9fafb;"></div>
            <p id="readFeedback" class="footer-text" style="text-align: left; margin-top: 1rem;"></p>
        </section>

        <button id="adminUnlockBtn" class="delete-btn" style="margin-top: 2rem;">ðŸ”’ Cloud administration</button>

        <section id="adminSection" class="card" style="margin-top: 2rem; display: none;">
            <h3>Cloud administration</h3>
            <p class="footer-text" style="text-align: left;">Manage wishes stored in the shared cloud service. Use the button below to delete them all.</p>
            <div class="stats-container" style="margin: 1rem 0;">
                <div class="stat-box">
                    <p>Saved wishes</p>
                    <h2 id="wishCount">0</h2>
                </div>
            </div>
            <button id="clearWishesBtn" class="delete-btn">Clear all wishes</button>
            <p id="adminFeedback" class="footer-text" style="text-align: left; margin-top: 1rem;"></p>
        </section>

        <div id="adminModal" class="modal" style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.35); align-items: center; justify-content: center;">
            <div class="modal-content" style="max-width: 420px; background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); width: calc(100% - 2rem);">
                <h3 style="margin-bottom: 0.5rem;">Unlock cloud administration</h3>
                <p class="footer-text" style="text-align: left;">Enter the password to manage saved wishes.</p>
                <div class="form-group" style="margin-top: 1rem;">
                    <label for="adminPasswordInput">Password</label>
                    <input type="password" id="adminPasswordInput" placeholder="Enter password" />
                </div>
                <p id="adminModalFeedback" class="footer-text" style="text-align: left; margin-top: 0.5rem;"></p>
                <div class="button-group" style="justify-content: flex-end; margin-top: 1rem;">
                    <button id="adminModalCancelBtn" class="secondary-btn">Cancel</button>
                    <button id="adminModalSubmitBtn">Unlock</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js";

        const secretsFile = 'secrets.txt';
        let db = null;
        let adminPassword = '';

        const shareSection = document.getElementById('shareSection');
        const readSection = document.getElementById('readSection');
        const shareViewBtn = document.getElementById('shareViewBtn');
        const readViewBtn = document.getElementById('readViewBtn');
        const submitWishBtn = document.getElementById('submitWishBtn');
        const randomWishBtn = document.getElementById('randomWishBtn');
        const clearWishesBtn = document.getElementById('clearWishesBtn');
        const adminUnlockBtn = document.getElementById('adminUnlockBtn');
        const adminModal = document.getElementById('adminModal');
        const adminModalCancelBtn = document.getElementById('adminModalCancelBtn');
        const adminModalSubmitBtn = document.getElementById('adminModalSubmitBtn');
        const adminPasswordInput = document.getElementById('adminPasswordInput');
        const adminModalFeedback = document.getElementById('adminModalFeedback');
        const adminSection = document.getElementById('adminSection');

        const wishInput = document.getElementById('wishInput');
        const shareFeedback = document.getElementById('shareFeedback');
        const randomWishDisplay = document.getElementById('randomWishDisplay');
        const readFeedback = document.getElementById('readFeedback');
        const adminFeedback = document.getElementById('adminFeedback');
        const wishCount = document.getElementById('wishCount');

        let cachedWishes = [];
        const bannedWords = [
            'ass',
            'bastard',
            'bitch',
            'bollocks',
            'crap',
            'cunt',
            'damn',
            'dick',
            'fuck',
            'fuk',
            'motherfucker',
            'piss',
            'shit',
            'slut',
            'twat',
            'whore',
        ];

        const bannedPhrases = [
            'go fuck yourself',
            'fuck you',
            'f you',
        ];

        const leetspeakMap = {
            '@': 'a',
            '4': 'a',
            '3': 'e',
            '1': 'i',
            '!': 'i',
            '0': 'o',
            '$': 's',
            '5': 's',
            '7': 't',
            '8': 'b',
        };

        async function loadSecrets() {
            const response = await fetch(secretsFile);
            if (!response.ok) throw new Error('Unable to load secrets file.');

            const text = await response.text();
            const entries = Object.fromEntries(
                text
                    .split('\n')
                    .map((line) => line.trim())
                    .filter((line) => line && !line.startsWith('#'))
                    .map((line) => line.split('='))
                    .filter((pair) => pair.length === 2)
            );

            return {
                supabaseUrl: entries.SUPABASE_URL || '',
                supabaseAnonKey: entries.SUPABASE_ANON_KEY || '',
                adminPassword: entries.ADMIN_PASSWORD || '',
            };
        }

        async function addWish(text) {
            if (!db) throw new Error('Database not initialized');
            const { error } = await db.from('wishes').insert({ text });
            if (error) throw error;
        }

        async function listWishes() {
            if (!db) throw new Error('Database not initialized');
            const { data, error } = await db
                .from('wishes')
                .select('*')
                .order('created_at', { ascending: true });

            if (error) throw error;
            return data;
        }

        async function clearAllWishes() {
            if (!db) throw new Error('Database not initialized');
            // Supabase requires a filter on delete operations; filter on a non-UUID column
            // to avoid casting issues with null when deleting all rows.
            const { error } = await db.from('wishes').delete().not('text', 'is', null);
            if (error) throw error;
        }

        async function countWishes() {
            if (!db) throw new Error('Database not initialized');
            const { count, error } = await db.from('wishes').select('*', { count: 'exact', head: true });

            if (error) throw error;
            return count;
        }

        async function loadWishes() {
            try {
                const wishes = await listWishes();
                cachedWishes = wishes || [];
            } catch (err) {
                console.error('Failed to load wishes', err);
                cachedWishes = [];
                showMessage(readFeedback, 'Unable to load wishes from the cloud. Please try again later.', true);
            }
            updateCount();
        }

        function getRandomWishFromCache() {
            if (!cachedWishes || !cachedWishes.length) return null;
            const index = Math.floor(Math.random() * cachedWishes.length);
            return cachedWishes[index];
        }

        function updateCount(total) {
            const value = typeof total === 'number' ? total : cachedWishes.length;
            wishCount.textContent = value;
        }

        async function refreshWishCountInAdmin(showError = true) {
            try {
                const total = await countWishes();
                updateCount(total ?? 0);
            } catch (err) {
                console.error('Failed to fetch wish count', err);
                if (showError) {
                    showMessage(adminFeedback, 'Unable to fetch wish count from the cloud.', true);
                }
            }
        }

        async function handleClearAllWishes() {
            try {
                await clearAllWishes();
                cachedWishes = [];
                randomWishDisplay.style.display = 'none';
                wishInput.value = '';
                updateCount(0);
                await refreshWishCountInAdmin(false);
                showMessage(adminFeedback, 'All wishes have been removed from the cloud.');
            } catch (err) {
                console.error('Failed to clear wishes', err);
                showMessage(adminFeedback, 'Error while clearing all wishes.', true);
            }
        }

        function switchView(view) {
            shareSection.style.display = view === 'share' ? 'block' : 'none';
            readSection.style.display = view === 'read' ? 'block' : 'none';
            shareFeedback.textContent = '';
            readFeedback.textContent = '';
        }

        function showMessage(element, message, isError = false) {
            element.textContent = message;
            element.style.color = isError ? '#b91c1c' : '#065f46';
        }

        function normalizeForProfanity(text) {
            const deaccented = text
                .normalize('NFD')
                .replace(/\p{Diacritic}/gu, '')
                .toLowerCase();

            const unleet = deaccented.replace(/[@431!0$578]/g, (char) => leetspeakMap[char] || char);
            const collapsed = unleet.replace(/[^a-z0-9]+/g, ' ').replace(/([a-z])\1{2,}/g, '$1$1');

            return collapsed.trim().replace(/\s+/g, ' ');
        }

        function containsProfanity(text) {
            const normalized = normalizeForProfanity(text);
            const normalizedNoSpaces = normalized.replace(/\s+/g, '');

            if (bannedPhrases.some((phrase) => normalized.includes(phrase))) return true;

            return bannedWords.some((word) => {
                const wordPattern = new RegExp(`(^|\\s)${word}(\\s|$)`);
                if (wordPattern.test(normalized)) return true;
                return normalizedNoSpaces.includes(word.replace(/\s+/g, ''));
            });
        }

        async function initializeApp() {
            try {
                const { supabaseUrl, supabaseAnonKey, adminPassword: passwordFromSecrets } = await loadSecrets();

                if (!supabaseUrl || !supabaseAnonKey) {
                    throw new Error('Missing Supabase credentials in secrets.txt.');
                }

                db = createClient(supabaseUrl, supabaseAnonKey);
                adminPassword = passwordFromSecrets;

                await loadWishes().finally(updateCount);
                switchView('share');
            } catch (err) {
                console.error('Failed to initialize application', err);
                showMessage(shareFeedback, 'Unable to initialize the wish service. Please check configuration.', true);
                showMessage(readFeedback, 'Unable to initialize the wish service. Please check configuration.', true);
            }
        }

        shareViewBtn.addEventListener('click', () => switchView('share'));
        readViewBtn.addEventListener('click', () => switchView('read'));

        submitWishBtn.addEventListener('click', async () => {
            const text = wishInput.value.trim();
            if (!text) {
                showMessage(shareFeedback, 'Enter a wish before submitting.', true);
                return;
            }

            if (containsProfanity(text)) {
                showMessage(shareFeedback, 'Please remove profanity before sending your wish.', true);
                return;
            }

            try {
                await addWish(text);
                await loadWishes();
                await refreshWishCountInAdmin(false);
                showMessage(shareFeedback, 'Wish added successfully!');
                wishInput.value = '';
            } catch (err) {
                console.error('Failed to save wish', err);
                showMessage(shareFeedback, 'Could not save your wish to the cloud. Please try again.', true);
            }
        });

        randomWishBtn.addEventListener('click', async () => {
            if (!cachedWishes.length) await loadWishes();
            if (!cachedWishes.length) {
                randomWishDisplay.style.display = 'none';
                showMessage(readFeedback, 'There are no saved wishes: add one first.', true);
                return;
            }

            const wish = getRandomWishFromCache();
            randomWishDisplay.textContent = wish.text;
            randomWishDisplay.style.display = 'block';
            showMessage(readFeedback, 'Here is a randomly selected wish.');
        });

        clearWishesBtn.addEventListener('click', async () => {
            if (!cachedWishes.length) await loadWishes();
            if (!cachedWishes.length) {
                showMessage(adminFeedback, 'There are no wishes to delete.');
                return;
            }
            const confirmDelete = confirm('Do you really want to delete all wishes saved in the shared cloud service?');
            if (!confirmDelete) return;
            await handleClearAllWishes();
        });

        function openAdminModal() {
            adminModal.style.display = 'flex';
            adminModalFeedback.textContent = '';
            adminPasswordInput.value = '';
            adminPasswordInput.focus();
        }

        function closeAdminModal() {
            adminModal.style.display = 'none';
        }

        function unlockAdminSection() {
            const providedPassword = adminPasswordInput.value;
            if (!adminPassword) {
                showMessage(adminModalFeedback, 'Admin password is not configured.', true);
                return;
            }

            if (providedPassword !== adminPassword) {
                showMessage(adminModalFeedback, 'Incorrect password. Please try again.', true);
                return;
            }
            adminSection.style.display = 'block';
            adminUnlockBtn.style.display = 'none';
            closeAdminModal();
            showMessage(adminFeedback, 'Cloud administration unlocked.');
            refreshWishCountInAdmin();
        }

        adminUnlockBtn.addEventListener('click', openAdminModal);
        adminModalCancelBtn.addEventListener('click', closeAdminModal);
        adminModalSubmitBtn.addEventListener('click', unlockAdminSection);
        adminPasswordInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                unlockAdminSection();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });
    </script>
</body>
</html>
