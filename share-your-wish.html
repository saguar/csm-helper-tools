<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Your Wish</title>
    <link rel="stylesheet" href="css/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container" style="max-width: 900px;">
        <h1>Share Your Wish</h1>
        <p>Share the wishes you want to store in the jar or pick a random one from everyone else. Please keep submissions polite and compliantâ€”avoid profanity, offensive content, or anything inappropriate.</p>

        <div class="button-group" style="margin-top: 1rem;">
            <button id="shareViewBtn">Share your wish</button>
            <button id="readViewBtn">Read a random wish</button>
        </div>

        <section id="shareSection" class="card" style="display: none;">
            <h2>Send a wish</h2>
            <p>Write your message and add it to the wish jar.</p>
            <div class="form-group">
                <label for="wishInput">Your wish</label>
                <textarea id="wishInput" rows="5" placeholder="Write your wish here"></textarea>
            </div>
            <button id="submitWishBtn">Send</button>
            <p id="shareFeedback" class="footer-text" style="text-align: left; margin-top: 1rem;"></p>
        </section>

        <section id="readSection" class="card" style="display: none;">
            <h2>Read a random wish</h2>
            <p>Press the button to pick a wish from those submitted.</p>
            <button id="randomWishBtn">Pick a wish</button>
            <div id="randomWishDisplay" class="card" style="display: none; margin-top: 1rem; background-color: #f9fafb;"></div>
            <p id="readFeedback" class="footer-text" style="text-align: left; margin-top: 1rem;"></p>
        </section>

        <button id="adminUnlockBtn" class="delete-btn" style="margin-top: 2rem;">ðŸ”’ Cloud administration</button>

        <section id="adminSection" class="card" style="margin-top: 2rem; display: none;">
            <h3>Cloud administration</h3>
            <p class="footer-text" style="text-align: left;">Wishes are stored in a shared Google Sheet so multiple users can participate. Use the button below to delete them all.</p>
            <div class="stats-container" style="margin: 1rem 0;">
                <div class="stat-box">
                    <p>Saved wishes</p>
                    <h2 id="wishCount">0</h2>
                </div>
            </div>
            <button id="clearWishesBtn" class="delete-btn">Clear all wishes</button>
            <p id="adminFeedback" class="footer-text" style="text-align: left; margin-top: 1rem;"></p>
        </section>

        <div id="adminModal" class="modal" style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.35); align-items: center; justify-content: center;">
            <div class="modal-content" style="max-width: 420px; background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); width: calc(100% - 2rem);">
                <h3 style="margin-bottom: 0.5rem;">Unlock cloud administration</h3>
                <p class="footer-text" style="text-align: left;">Enter the password to manage saved wishes.</p>
                <div class="form-group" style="margin-top: 1rem;">
                    <label for="adminPasswordInput">Password</label>
                    <input type="password" id="adminPasswordInput" placeholder="Enter password" />
                </div>
                <p id="adminModalFeedback" class="footer-text" style="text-align: left; margin-top: 0.5rem;"></p>
                <div class="button-group" style="justify-content: flex-end; margin-top: 1rem;">
                    <button id="adminModalCancelBtn" class="secondary-btn">Cancel</button>
                    <button id="adminModalSubmitBtn">Unlock</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_ENDPOINT = 'https://script.google.com/a/macros/salesforce.com/s/AKfycbzpy8--MuXzqbUJfcYZpMY09-Ud6_rnUb_YND5szlg_Ow887rkap5_-E6rdxH1NQDiWRQ/exec'; // Google Apps Script Web App URL
        const ADMIN_PASSWORD = 'Password.123';
        const ADMIN_TOKEN = 'REPLACE_WITH_ADMIN_TOKEN'; // Optional extra protection for destructive operations

        const shareSection = document.getElementById('shareSection');
        const readSection = document.getElementById('readSection');
        const shareViewBtn = document.getElementById('shareViewBtn');
        const readViewBtn = document.getElementById('readViewBtn');
        const submitWishBtn = document.getElementById('submitWishBtn');
        const randomWishBtn = document.getElementById('randomWishBtn');
        const clearWishesBtn = document.getElementById('clearWishesBtn');
        const adminUnlockBtn = document.getElementById('adminUnlockBtn');
        const adminModal = document.getElementById('adminModal');
        const adminModalCancelBtn = document.getElementById('adminModalCancelBtn');
        const adminModalSubmitBtn = document.getElementById('adminModalSubmitBtn');
        const adminPasswordInput = document.getElementById('adminPasswordInput');
        const adminModalFeedback = document.getElementById('adminModalFeedback');
        const adminSection = document.getElementById('adminSection');

        const wishInput = document.getElementById('wishInput');
        const shareFeedback = document.getElementById('shareFeedback');
        const randomWishDisplay = document.getElementById('randomWishDisplay');
        const readFeedback = document.getElementById('readFeedback');
        const adminFeedback = document.getElementById('adminFeedback');
        const wishCount = document.getElementById('wishCount');

        let cachedWishes = [];

        async function loadWishes() {
            try {
                const response = await fetch(`${SHEET_ENDPOINT}?action=list`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                cachedWishes = Array.isArray(data?.wishes) ? data.wishes : [];
            } catch (err) {
                console.error('Failed to load wishes', err);
                cachedWishes = [];
                showMessage(readFeedback, 'Unable to load wishes from the cloud. Please try again later.', true);
            }
            updateCount();
        }

        async function saveWishToCloud(text) {
            const body = new URLSearchParams({ action: 'add', text });
            const response = await fetch(SHEET_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body
            });

            if (!response.ok) throw new Error('Failed to save wish');
            const result = await response.json();
            if (!result.success) throw new Error(result.message || 'Unknown error');
        }

        function updateCount() {
            wishCount.textContent = cachedWishes.length;
        }

        function switchView(view) {
            shareSection.style.display = view === 'share' ? 'block' : 'none';
            readSection.style.display = view === 'read' ? 'block' : 'none';
            shareFeedback.textContent = '';
            readFeedback.textContent = '';
        }

        function showMessage(element, message, isError = false) {
            element.textContent = message;
            element.style.color = isError ? '#b91c1c' : '#065f46';
        }

        shareViewBtn.addEventListener('click', () => switchView('share'));
        readViewBtn.addEventListener('click', () => switchView('read'));

        submitWishBtn.addEventListener('click', async () => {
            const text = wishInput.value.trim();
            if (!text) {
                showMessage(shareFeedback, 'Enter a wish before submitting.', true);
                return;
            }

            try {
                await saveWishToCloud(text);
                await loadWishes();
                showMessage(shareFeedback, 'Wish added successfully!');
                wishInput.value = '';
            } catch (err) {
                console.error('Failed to save wish', err);
                showMessage(shareFeedback, 'Could not save your wish to the cloud. Please try again.', true);
            }
        });

        randomWishBtn.addEventListener('click', async () => {
            if (!cachedWishes.length) await loadWishes();
            if (!cachedWishes.length) {
                randomWishDisplay.style.display = 'none';
                showMessage(readFeedback, 'There are no saved wishes: add one first.', true);
                return;
            }

            const randomIndex = Math.floor(Math.random() * cachedWishes.length);
            const wish = cachedWishes[randomIndex];
            randomWishDisplay.textContent = wish.text;
            randomWishDisplay.style.display = 'block';
            showMessage(readFeedback, 'Here is a randomly selected wish.');
        });

        clearWishesBtn.addEventListener('click', async () => {
            if (!cachedWishes.length) await loadWishes();
            if (!cachedWishes.length) {
                showMessage(adminFeedback, 'There are no wishes to delete.');
                return;
            }
            const confirmDelete = confirm('Do you really want to delete all wishes saved in the shared cloud sheet?');
            if (!confirmDelete) return;
            try {
                const body = new URLSearchParams({ action: 'clear', token: ADMIN_TOKEN });
                const response = await fetch(SHEET_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body
                });
                if (!response.ok) throw new Error('Failed to clear wishes');
                const result = await response.json();
                if (!result.success) throw new Error(result.message || 'Unknown error');

                cachedWishes = [];
                randomWishDisplay.style.display = 'none';
                wishInput.value = '';
                updateCount();
                showMessage(adminFeedback, 'All wishes have been removed from the cloud.');
            } catch (err) {
                console.error('Failed to clear wishes', err);
                showMessage(adminFeedback, 'Could not clear wishes. Please verify admin credentials and try again.', true);
            }
        });

        function openAdminModal() {
            adminModal.style.display = 'flex';
            adminModalFeedback.textContent = '';
            adminPasswordInput.value = '';
            adminPasswordInput.focus();
        }

        function closeAdminModal() {
            adminModal.style.display = 'none';
        }

        function unlockAdminSection() {
            const providedPassword = adminPasswordInput.value;
            if (providedPassword !== ADMIN_PASSWORD) {
                showMessage(adminModalFeedback, 'Incorrect password. Please try again.', true);
                return;
            }
            adminSection.style.display = 'block';
            adminUnlockBtn.style.display = 'none';
            closeAdminModal();
            showMessage(adminFeedback, 'Cloud administration unlocked.');
        }

        adminUnlockBtn.addEventListener('click', openAdminModal);
        adminModalCancelBtn.addEventListener('click', closeAdminModal);
        adminModalSubmitBtn.addEventListener('click', unlockAdminSection);
        adminPasswordInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                unlockAdminSection();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadWishes().finally(updateCount);
            switchView('share');
        });
    </script>
</body>
</html>
