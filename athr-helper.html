<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enel Global Services | Org Health Dashboard</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- D3.js for Charts -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- SheetJS for Excel parsing -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;
        
        // Icon component using Font Awesome
        const Icon = ({ name, size = 24, className = '' }) => (
            <i className={`fas fa-${name}`} style={{ fontSize: `${size}px` }} />
        );
        
        // Icon mappings
        const LayoutDashboard = (props) => <Icon name="th-large" {...props} />;
        const Database = (props) => <Icon name="database" {...props} />;
        const Activity = (props) => <Icon name="activity" {...props} />;
        const Code = (props) => <Icon name="code" {...props} />;
        const Layers = (props) => <Icon name="layer-group" {...props} />;
        const AlertTriangle = (props) => <Icon name="triangle-exclamation" {...props} />;
        const CheckCircle = (props) => <Icon name="check-circle" {...props} />;
        const HardDrive = (props) => <Icon name="hard-drive" {...props} />;
        const FileWarning = (props) => <Icon name="file-circle-exclamation" {...props} />;
        const Server = (props) => <Icon name="server" {...props} />;
        const Zap = (props) => <Icon name="bolt" {...props} />;
        const Menu = (props) => <Icon name="bars" {...props} />;
        const X = (props) => <Icon name="xmark" {...props} />;
        const ChevronRight = (props) => <Icon name="chevron-right" {...props} />;
        const User = (props) => <Icon name="user" {...props} />;

        const severityColors = {
            BLOCKER: '#EF4444',
            CRITICAL: '#F97316',
            MAJOR: '#EAB308',
            MINOR: '#3B82F6',
            INFO: '#9CA3AF'
        };

        const toNumber = (value) => {
            if (typeof value === 'number') return value;
            if (typeof value !== 'string') return 0;
            const cleaned = value.replace(/,/g, '').trim();
            if (!cleaned) return 0;
            const num = Number(cleaned);
            return Number.isFinite(num) ? num : 0;
        };

        const parseStorageValue = (value) => {
            if (typeof value === 'number') return { value, unit: '' };
            if (typeof value !== 'string') return { value: 0, unit: '' };
            const match = value.trim().match(/^([\d.]+)\s*([A-Za-z]+)?/);
            if (!match) return { value: 0, unit: '' };
            return { value: Number(match[1]), unit: match[2] || '' };
        };

        const formatCount = (value) => {
            if (!Number.isFinite(value)) return '';
            const abs = Math.abs(value);
            if (abs >= 1e9) return `${(value / 1e9).toFixed(1).replace(/\.0$/, '')}B`;
            if (abs >= 1e6) return `${(value / 1e6).toFixed(1).replace(/\.0$/, '')}M`;
            if (abs >= 1e3) return `${(value / 1e3).toFixed(1).replace(/\.0$/, '')}K`;
            return `${Math.round(value)}`;
        };

        const getCell = (row, keys) => {
            for (const key of keys) {
                if (key in row) return row[key];
            }
            return '';
        };

        // --- COMPONENTS ---

        const Sidebar = ({ activeTab, setActiveTab, isOpen, setIsOpen }) => {
            const menuItems = [
                { id: 'overview', label: 'Panoramica', icon: LayoutDashboard },
                { id: 'quality', label: 'Qualità Codice', icon: Code },
                { id: 'storage', label: 'Storage & Dati', icon: Database },
                { id: 'performance', label: 'Performance', icon: Activity },
                { id: 'inventory', label: 'Inventario', icon: Layers },
            ];

            return (
                <>
                    {/* Mobile Overlay */}
                    {isOpen && (
                        <div 
                            className="fixed inset-0 z-20 bg-black bg-opacity-50 lg:hidden"
                            onClick={() => setIsOpen(false)}
                        ></div>
                    )}

                    {/* Sidebar */}
                    <aside className={`fixed top-0 left-0 z-30 h-full w-64 bg-slate-900 text-white transition-transform transform lg:translate-x-0 ${isOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="flex items-center justify-between p-4 border-b border-slate-700">
                            <div className="flex items-center space-x-2">
                                <div className="p-2 bg-blue-600 rounded-lg">
                                    <Server size={20} />
                                </div>
                                <div>
                                    <h1 className="font-bold text-lg leading-tight">Enel Global</h1>
                                    <p className="text-xs text-slate-400">Salesforce Dashboard</p>
                                </div>
                            </div>
                            <button onClick={() => setIsOpen(false)} className="lg:hidden">
                                <X size={24} />
                            </button>
                        </div>

                        <nav className="mt-6 px-2 space-y-2">
                            {menuItems.map((item) => (
                                <button
                                    key={item.id}
                                    onClick={() => { setActiveTab(item.id); setIsOpen(false); }}
                                    className={`flex items-center w-full px-4 py-3 rounded-lg transition-colors ${
                                        activeTab === item.id 
                                        ? 'bg-blue-600 text-white shadow-lg' 
                                        : 'text-slate-300 hover:bg-slate-800 hover:text-white'
                                    }`}
                                >
                                    <item.icon size={20} className="mr-3" />
                                    <span className="font-medium">{item.label}</span>
                                    {activeTab === item.id && <ChevronRight size={16} className="ml-auto" />}
                                </button>
                            ))}
                        </nav>

                        <div className="absolute bottom-0 w-full p-4 border-t border-slate-800 bg-slate-900">
                            <div className="flex items-center space-x-3">
                                <div className="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center">
                                    <User size={16} />
                                </div>
                                <div>
                                    <p className="text-sm font-medium">Admin User</p>
                                    <p className="text-xs text-slate-400">View Only</p>
                                </div>
                            </div>
                        </div>
                    </aside>
                </>
            );
        };

        const StatCard = ({ title, value, subtext, icon: Icon, colorClass, alert }) => (
            <div className={`bg-white p-6 rounded-xl card-shadow border-l-4 ${colorClass}`}>
                <div className="flex justify-between items-start">
                    <div>
                        <p className="text-sm font-medium text-slate-500 uppercase tracking-wider">{title}</p>
                        <h3 className="text-2xl font-bold text-slate-800 mt-1">{value}</h3>
                        {subtext && <p className="text-sm text-slate-400 mt-2">{subtext}</p>}
                    </div>
                    <div className={`p-3 rounded-full ${alert ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-600'}`}>
                        <Icon size={24} />
                    </div>
                </div>
            </div>
        );

        const AlertBanner = ({ title, message }) => (
            <div className="bg-red-50 border border-red-200 rounded-lg p-4 flex items-start space-x-3 mb-6">
                <AlertTriangle className="text-red-600 mt-1 flex-shrink-0" size={20} />
                <div>
                    <h4 className="font-semibold text-red-800">{title}</h4>
                    <p className="text-sm text-red-700 mt-1">{message}</p>
                </div>
            </div>
        );

        const OverviewTab = ({ storageData, codeQualityData, topStorageObjects, userStorage, apexClassCount, apiVersionRange }) => {
            const dataStorage = storageData.find((item) => item.name === 'Data Storage');
            const blocker = codeQualityData.find((item) => item.name === 'BLOCKER');
            const topUser = userStorage[0];
            const topObject = topStorageObjects[0];
            const storageValue = dataStorage ? `${Math.round(dataStorage.percent)}%` : '--';
            const storageSubtext = dataStorage
                ? `${dataStorage.used} ${dataStorage.unit} su ${dataStorage.limit} ${dataStorage.unit}`
                : 'Nessun dato';
            const blockerValue = blocker ? `${formatCount(blocker.testClasses)}/${formatCount(blocker.codeComponents)}` : '--';
            const storageAlertMessage = dataStorage
                ? `Il Data Storage è al ${Math.round(dataStorage.percent)}% della capacità (${dataStorage.used} ${dataStorage.unit}). Azioni di archiviazione o pulizia sono richieste per evitare il blocco dei processi.`
                : 'Carica un file Excel per valutare lo stato dello storage.';
            return (
            <div className="space-y-6 animate-fade-in">
                {/* Stats Row */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <StatCard 
                        title="Storage Dati" 
                        value={storageValue} 
                        subtext={storageSubtext} 
                        icon={HardDrive} 
                        colorClass="border-red-500" 
                        alert={dataStorage ? dataStorage.percent > 90 : false}
                    />
                    <StatCard 
                        title="Problemi Bloccanti" 
                        value={blockerValue} 
                        subtext="Test / Code" 
                        icon={FileWarning} 
                        colorClass="border-red-500"
                        alert={true}
                    />
                    <StatCard 
                        title="Classi Apex" 
                        value={apexClassCount ? apexClassCount.toLocaleString() : '-'} 
                        subtext="Totale classi" 
                        icon={Code} 
                        colorClass="border-blue-500"
                    />
                    <StatCard 
                        title="API Versions" 
                        value={apiVersionRange || '-'} 
                        subtext="Range versioni attive" 
                        icon={Zap} 
                        colorClass="border-green-500"
                    />
                </div>

                <AlertBanner 
                    title="Attenzione: Storage Critico" 
                    message={storageAlertMessage}
                />

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {/* Chart 1: Quality Summary */}
                    <div className="bg-white p-6 rounded-xl card-shadow">
                        <h3 className="font-bold text-lg text-slate-800 mb-4">Stato Salute Codice</h3>
                        <div className="h-64 flex items-end justify-around gap-4 px-4">
                            {codeQualityData.map((item, idx) => {
                                const maxValue = Math.max(...codeQualityData.map(d => Math.max(d.testClasses, d.codeComponents)), 0);
                                const testHeight = maxValue ? (item.testClasses / maxValue) * 100 : 0;
                                const codeHeight = maxValue ? (item.codeComponents / maxValue) * 100 : 0;
                                return (
                                    <div key={idx} className="flex-1 flex flex-col items-center">
                                        <div className="w-full flex items-end gap-1 h-48">
                                            <div
                                                className="flex-1 rounded-t"
                                                style={{ height: `${testHeight}%`, backgroundColor: item.color, minHeight: '8px', opacity: 0.6 }}
                                                title={`${item.name} Test: ${item.testClasses.toLocaleString()}`}
                                            ></div>
                                            <div
                                                className="flex-1 rounded-t"
                                                style={{ height: `${codeHeight}%`, backgroundColor: item.color, minHeight: '8px' }}
                                                title={`${item.name} Code: ${item.codeComponents.toLocaleString()}`}
                                            ></div>
                                        </div>
                                        <p className="text-xs text-slate-600 mt-2 text-center truncate">{item.name}</p>
                                        <p className="text-xs font-bold text-slate-800">{formatCount(item.testClasses)}/{formatCount(item.codeComponents)}</p>
                                    </div>
                                );
                            })}
                        </div>
                        <div className="flex items-center justify-center gap-4 text-xs text-slate-500 mt-4">
                            <span className="inline-flex items-center gap-2"><span className="w-3 h-3 rounded bg-slate-400"></span>Test Classes</span>
                            <span className="inline-flex items-center gap-2"><span className="w-3 h-3 rounded bg-slate-600"></span>Code Components</span>
                        </div>
                    </div>

                    {/* Chart 2: Storage Usage */}
                    <div className="bg-white p-6 rounded-xl card-shadow">
                        <h3 className="font-bold text-lg text-slate-800 mb-4">Utilizzo Storage (TB)</h3>
                        <div className="space-y-4">
                            {storageData.map((item, idx) => (
                                <div key={idx}>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span className="font-medium text-slate-700">{item.name}</span>
                                        <span className={`font-bold ${item.percent > 90 ? 'text-red-600' : 'text-slate-600'}`}>
                                            {item.used} / {item.limit} {item.unit} ({item.percent}%)
                                        </span>
                                    </div>
                                    <div className="w-full bg-slate-200 rounded-full h-2.5">
                                        <div 
                                            className={`h-2.5 rounded-full ${item.percent > 90 ? 'bg-red-600' : 'bg-blue-600'}`} 
                                            style={{ width: `${item.percent}%` }}
                                        ></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="mt-6 bg-blue-50 p-4 rounded-lg">
                            <h4 className="text-sm font-bold text-blue-800 mb-2">Insight Rapidi</h4>
                            <ul className="text-sm text-blue-700 space-y-1">
                                <li>• Utente principale storage: <strong>{topUser ? `${topUser.name} (${topUser.storage})` : '-'}</strong></li>
                                <li>• Oggetto più pesante: <strong>{topObject ? `${topObject.name} (${topObject.size})` : '-'}</strong></li>
                                <li>• Problemi critici codice: <strong>{codeQualityData.find((item) => item.name === 'CRITICAL')?.codeComponents?.toLocaleString() || '-'}</strong></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        );
        };

        const QualityTab = ({ codeQualityData, topIssuesFiles, codeQualityRules }) => (
            <div className="space-y-6 animate-fade-in">
                <div className="bg-white p-6 rounded-xl card-shadow">
                    <div className="flex justify-between items-center mb-6">
                        <h3 className="font-bold text-lg text-slate-800">Top 5 Componenti con più Problemi</h3>
                        <span className="bg-red-100 text-red-600 text-xs px-2 py-1 rounded-full font-bold">Priority High</span>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="min-w-full text-left">
                            <thead className="bg-slate-50 text-slate-500 uppercase text-xs">
                                <tr>
                                    <th className="px-4 py-3">Nome File</th>
                                    <th className="px-4 py-3">Numero Issues</th>
                                    <th className="px-4 py-3">Stato</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100 text-sm">
                                {topIssuesFiles.map((file, i) => (
                                    <tr key={i} className="hover:bg-slate-50 transition-colors">
                                        <td className="px-4 py-3 font-medium text-slate-700">{file.name}</td>
                                        <td className="px-4 py-3 text-red-600 font-bold">{file.issues}</td>
                                        <td className="px-4 py-3">
                                            <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                                                Refactor Richiesto
                                            </span>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="bg-white p-6 rounded-xl card-shadow">
                        <h3 className="font-bold text-lg text-slate-800 mb-4">Regole Violate (Top 3)</h3>
                        <ul className="space-y-4">
                            {codeQualityRules.length === 0 && (
                                <li className="text-sm text-slate-500">Nessun dato disponibile.</li>
                            )}
                            {codeQualityRules.map((rule, idx) => (
                                <li key={idx} className="flex items-start">
                                    <span className="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-orange-100 text-orange-600 rounded-full mr-3 text-xs font-bold">{idx + 1}</span>
                                    <div>
                                        <p className="font-medium text-slate-800">{rule.name}</p>
                                        <p className="text-sm text-slate-500">{rule.count.toLocaleString()} occorrenze.</p>
                                    </div>
                                </li>
                            ))}
                        </ul>
                    </div>
                    <div className="bg-white p-6 rounded-xl card-shadow">
                        <h3 className="font-bold text-lg text-slate-800 mb-4">Distribuzione Gravità</h3>
                        <div className="h-56 flex flex-col items-center justify-center">
                            <div className="flex flex-wrap justify-center gap-4">
                                {codeQualityData.map((item, idx) => {
                                    const total = codeQualityData.reduce((sum, d) => sum + d.testClasses + d.codeComponents, 0);
                                    const percent = total ? (((item.testClasses + item.codeComponents) / total) * 100).toFixed(1) : '0.0';
                                    return (
                                        <div key={idx} className="text-center">
                                            <div className="flex items-center justify-center">
                                                <div className="w-20 h-20 rounded-full flex items-center justify-center text-white font-bold text-sm" style={{ backgroundColor: item.color }}>
                                                    {percent}%
                                                </div>
                                            </div>
                                            <p className="text-xs text-slate-600 mt-2 font-medium">{item.name}</p>
                                            <p className="text-xs text-slate-500">{formatCount(item.testClasses)}/{formatCount(item.codeComponents)}</p>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );

        const StorageTab = ({ topStorageObjects, topFileStorageObjects, userStorage, softDeletedRecords }) => {
            const alertMessage = topStorageObjects.length
                ? `Gli oggetti ${topStorageObjects.slice(0, 2).map((obj) => obj.name).join(' e ')} consumano da soli oltre ${topStorageObjects.slice(0, 2).map((obj) => obj.size).join(' + ')} di spazio.`
                : 'Carica un file Excel per valutare i maggiori consumer.';
            return (
             <div className="space-y-6 animate-fade-in">
                <AlertBanner 
                    title="Analisi Top Consumer" 
                    message={alertMessage}
                />
                
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div className="bg-white p-6 rounded-xl card-shadow">
                        <h3 className="font-bold text-lg text-slate-800 mb-4">Top 5 Oggetti per Storage</h3>
                        <table className="min-w-full">
                            <thead className="bg-slate-50 text-slate-500 uppercase text-xs">
                                <tr>
                                    <th className="px-4 py-2 text-left">Oggetto</th>
                                    <th className="px-4 py-2 text-right">Record Count</th>
                                    <th className="px-4 py-2 text-right">Size</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100 text-sm">
                                {topStorageObjects.map((obj, i) => (
                                    <tr key={i}>
                                        <td className="px-4 py-3 font-medium text-slate-700">{obj.name}</td>
                                        <td className="px-4 py-3 text-right text-slate-500">{obj.count}</td>
                                        <td className="px-4 py-3 text-right font-bold text-slate-800">{obj.size}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    <div className="bg-white p-6 rounded-xl card-shadow">
                        <h3 className="font-bold text-lg text-slate-800 mb-4">Top 5 Oggetti File Storage</h3>
                        <table className="min-w-full">
                            <thead className="bg-slate-50 text-slate-500 uppercase text-xs">
                                <tr>
                                    <th className="px-4 py-2 text-left">Oggetto</th>
                                    <th className="px-4 py-2 text-right">Record Count</th>
                                    <th className="px-4 py-2 text-right">Size</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100 text-sm">
                                {topFileStorageObjects.map((obj, i) => (
                                    <tr key={i}>
                                        <td className="px-4 py-3 font-medium text-slate-700">{obj.name}</td>
                                        <td className="px-4 py-3 text-right text-slate-500">{obj.count}</td>
                                        <td className="px-4 py-3 text-right font-bold text-slate-800">{obj.size}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div className="bg-white p-6 rounded-xl card-shadow">
                    <h3 className="font-bold text-lg text-slate-800 mb-4">Top Utenti per Consumo Dati</h3>
                    <div className="space-y-4">
                        {userStorage.map((user, i) => (
                            <div key={i} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                <div className="flex items-center">
                                    <div className="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mr-3 font-bold text-xs">
                                        {user.name.charAt(0)}
                                    </div>
                                    <span className="font-medium text-slate-700">{user.name}</span>
                                </div>
                                <div className="text-right">
                                    <span className="block font-bold text-slate-800">{user.storage}</span>
                                    <span className="text-xs text-slate-500">{user.percent} del totale</span>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>

                <div className="bg-white p-6 rounded-xl card-shadow">
                    <h3 className="font-bold text-lg text-slate-800 mb-4">Records Soft Deleted (Cestino)</h3>
                    <p className="text-sm text-slate-600 mb-4">Questi record occupano spazio ma sono nel cestino. Svuotare il cestino potrebbe liberare spazio significativo.</p>
                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        {softDeletedRecords.length === 0 && (
                            <div className="col-span-full text-sm text-slate-500">Nessun dato disponibile.</div>
                        )}
                        {softDeletedRecords.map((record, i) => (
                            <div key={i} className="p-4 bg-orange-50 border border-orange-100 rounded-lg text-center">
                                <p className="text-xs uppercase text-orange-600 font-bold">{record.name}</p>
                                <p className="text-xl font-bold text-orange-800">{formatCount(record.deleted)}</p>
                                <p className="text-xs text-orange-600">Records eliminati</p>
                            </div>
                        ))}
                    </div>
                </div>
             </div>
        );
        };

        const PerformanceTab = ({ slowApex, dataSkews, queries }) => (
            <div className="space-y-6 animate-fade-in">
                 <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                     <div className="bg-white p-6 rounded-xl card-shadow">
                        <h3 className="font-bold text-lg text-slate-800 mb-4">Processi Apex più Lenti (Avg Time)</h3>
                         <div className="space-y-4">
                            {slowApex.map((item, i) => (
                                <div key={i}>
                                    <div className="flex justify-between text-sm mb-1 gap-2">
                                        <span className="font-medium text-slate-700 truncate">{item.name}</span>
                                        <span className="font-bold text-red-600 whitespace-nowrap">{item.avgTime} ms</span>
                                    </div>
                                    <div className="w-full bg-slate-200 rounded-full h-1.5">
                                        <div 
                                            className="bg-red-500 h-1.5 rounded-full" 
                                            style={{ width: `${(item.avgTime / 20000) * 100}%` }}
                                        ></div>
                                    </div>
                                    <p className="text-xs text-slate-400 mt-1">Eseguito {item.count.toLocaleString()} volte</p>
                                </div>
                            ))}
                        </div>
                     </div>

                     <div className="bg-white p-6 rounded-xl card-shadow">
                        <h3 className="font-bold text-lg text-slate-800 mb-4">Data Skew (Account Parent)</h3>
                        <p className="text-sm text-slate-600 mb-4">I seguenti Account hanno un numero eccessivo di Case associati (>10k), causando potenziali problemi di locking.</p>
                        <table className="min-w-full text-sm">
                            <thead className="bg-slate-50 text-slate-500 uppercase text-xs">
                                <tr>
                                    <th className="px-2 py-2 text-left">Parent ID</th>
                                    <th className="px-2 py-2 text-right">Child Count</th>
                                </tr>
                            </thead>
                             <tbody className="divide-y divide-slate-100">
                                {dataSkews.map((skew, i) => (
                                    <tr key={i}>
                                        <td className="px-2 py-2 font-mono text-slate-600">{skew.id}</td>
                                        <td className="px-2 py-2 text-right font-bold text-red-600">{skew.size.toLocaleString()}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                     </div>
                 </div>

                 <div className="bg-white p-6 rounded-xl card-shadow">
                    <h3 className="font-bold text-lg text-slate-800 mb-4">Query Lente (Slowest Queries)</h3>
                    <div className="overflow-x-auto">
                        <table className="min-w-full text-sm">
                            <thead className="bg-slate-50 text-slate-500 uppercase text-xs">
                                <tr>
                                    <th className="px-4 py-2 text-left">Query Origin</th>
                                    <th className="px-4 py-2 text-right">Avg Time (ms)</th>
                                    <th className="px-4 py-2 text-right">Max Time (ms)</th>
                                    <th className="px-4 py-2 text-right">Count</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {queries.map((query, i) => (
                                    <tr key={i}>
                                        <td className="px-4 py-2 text-slate-700 font-mono text-xs">{query.name}</td>
                                        <td className="px-4 py-2 text-right text-red-600 font-bold">{query.avgTime.toLocaleString()}</td>
                                        <td className="px-4 py-2 text-right">{query.maxTime.toLocaleString()}</td>
                                        <td className="px-4 py-2 text-right">{query.count.toLocaleString()}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        );

        const InventoryTab = () => (
             <div className="space-y-6 animate-fade-in">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div className="bg-white p-6 rounded-xl card-shadow border-t-4 border-purple-500">
                        <h4 className="text-slate-500 text-sm uppercase">Flows</h4>
                        <p className="text-3xl font-bold text-slate-800 mt-2">128+</p>
                        <p className="text-xs text-slate-400 mt-1">Definizioni attive</p>
                    </div>
                    <div className="bg-white p-6 rounded-xl card-shadow border-t-4 border-pink-500">
                        <h4 className="text-slate-500 text-sm uppercase">Trigger Apex</h4>
                        <p className="text-3xl font-bold text-slate-800 mt-2">Multiple</p>
                        <p className="text-xs text-slate-400 mt-1">Per oggetto (es. ITA_IFM_Privacy__c ha 2 trigger)</p>
                    </div>
                     <div className="bg-white p-6 rounded-xl card-shadow border-t-4 border-indigo-500">
                        <h4 className="text-slate-500 text-sm uppercase">Record Types</h4>
                        <p className="text-3xl font-bold text-slate-800 mt-2">313</p>
                        <p className="text-xs text-slate-400 mt-1">Solo sull'oggetto Case</p>
                    </div>
                </div>

                <div className="bg-white p-6 rounded-xl card-shadow">
                    <h3 className="font-bold text-lg text-slate-800 mb-4">Complessità Oggetti (Campi & Layout)</h3>
                    <table className="min-w-full text-sm">
                        <thead className="bg-slate-50 text-slate-500 uppercase text-xs">
                             <tr>
                                <th className="px-4 py-2 text-left">Oggetto</th>
                                <th className="px-4 py-2 text-center">Record Types</th>
                                <th className="px-4 py-2 text-center">Page Layouts</th>
                                <th className="px-4 py-2 text-center">Validation Rules Attive</th>
                            </tr>
                        </thead>
                         <tbody className="divide-y divide-slate-100">
                            <tr>
                                <td className="px-4 py-3 font-medium">Case</td>
                                <td className="px-4 py-3 text-center">313</td>
                                <td className="px-4 py-3 text-center">81</td>
                                <td className="px-4 py-3 text-center">13</td>
                            </tr>
                             <tr>
                                <td className="px-4 py-3 font-medium">ITA_IFM_Case_Items__c</td>
                                <td className="px-4 py-3 text-center">263</td>
                                <td className="px-4 py-3 text-center">63</td>
                                <td className="px-4 py-3 text-center">5</td>
                            </tr>
                            <tr>
                                <td className="px-4 py-3 font-medium">NE__Order_Header__c</td>
                                <td className="px-4 py-3 text-center">208</td>
                                <td className="px-4 py-3 text-center">-</td>
                                <td className="px-4 py-3 text-center">-</td>
                            </tr>
                             <tr>
                                <td className="px-4 py-3 font-medium">ITA_IFM_Agent__c</td>
                                <td className="px-4 py-3 text-center">-</td>
                                <td className="px-4 py-3 text-center">-</td>
                                <td className="px-4 py-3 text-center font-bold text-orange-600">22</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
             </div>
        );

        // --- MAIN APP ---

        const App = () => {
            const [activeTab, setActiveTab] = useState('overview');
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [fileName, setFileName] = useState('');
            const [loadError, setLoadError] = useState('');
            const [lastUpdated, setLastUpdated] = useState('Ultimo aggiornamento: -');
            const [data, setData] = useState({
                storageData: [],
                codeQualityData: [],
                codeQualityRules: [],
                topIssuesFiles: [],
                topStorageObjects: [],
                topFileStorageObjects: [],
                softDeletedRecords: [],
                slowApex: [],
                dataSkews: [],
                userStorage: [],
                queries: [],
                apexClassCount: 0,
                apiVersionRange: ''
            });
            const [warnings, setWarnings] = useState([]);
            
            const parseWorkbook = (workbook) => {
                const warnings = [];
                const toRows = (sheetName) => {
                    const sheet = workbook.Sheets[sheetName];
                    if (!sheet) {
                        warnings.push(`Foglio mancante: ${sheetName}.`);
                        return [];
                    }
                    const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
                    if (!rows.length) warnings.push(`Foglio vuoto: ${sheetName}.`);
                    return rows;
                };
                const validateColumns = (rows, sheetName, required) => {
                    if (!rows.length) return;
                    const columns = Object.keys(rows[0]);
                    required.forEach((col) => {
                        if (!columns.includes(col)) {
                            warnings.push(`Colonna mancante in ${sheetName}: ${col}.`);
                        }
                    });
                };

                const qualityRows = toRows('Code Quality Issues by Severity');
                validateColumns(qualityRows, 'Code Quality Issues by Severity', ['Severity', 'Test classes', 'Code Components']);
                const codeQualityData = qualityRows.map((row) => ({
                    name: getCell(row, ['Severity']),
                    testClasses: toNumber(getCell(row, ['Test classes'])),
                    codeComponents: toNumber(getCell(row, ['Code Components'])),
                    color: severityColors[getCell(row, ['Severity'])] || '#9CA3AF'
                })).filter((row) => row.name);

                const rulesRows = toRows('Code Quality Issues by Rule');
                validateColumns(rulesRows, 'Code Quality Issues by Rule', ['Rule Name']);
                const codeQualityRules = rulesRows.map((row) => ({
                    name: getCell(row, ['Rule Name']),
                    count: toNumber(getCell(row, ['Code Components', 'Test classes']))
                })).filter((row) => row.name).slice(0, 3);

                if (rulesRows.length) {
                    const columns = Object.keys(rulesRows[0] || {});
                    if (!columns.includes('Code Components') && !columns.includes('Test classes')) {
                        warnings.push('Colonna mancante in Code Quality Issues by Rule: Code Components o Test classes.');
                    }
                }

                const topComponentsRows = toRows('Top Components List');
                validateColumns(topComponentsRows, 'Top Components List', ['File Name', 'Issues']);
                const topIssuesFiles = topComponentsRows.map((row) => ({
                    name: getCell(row, ['File Name']),
                    issues: toNumber(getCell(row, ['Issues']))
                })).filter((row) => row.name).slice(0, 5);

                const storageRows = toRows('Overall Storage Usage');
                validateColumns(storageRows, 'Overall Storage Usage', ['Storage Type', 'Limit', 'Used', 'Percent Used']);
                const storageData = storageRows.map((row) => {
                    const used = parseStorageValue(getCell(row, ['Used']));
                    const limit = parseStorageValue(getCell(row, ['Limit']));
                    const percentRaw = toNumber(getCell(row, ['Percent Used']));
                    const percent = percentRaw <= 1 ? percentRaw * 100 : percentRaw;
                    return {
                        name: getCell(row, ['Storage Type']),
                        used: used.value,
                        limit: limit.value,
                        unit: used.unit || limit.unit || '',
                        percent: Math.round(percent)
                    };
                }).filter((row) => row.name);

                const dataStorageRows = toRows('Current Data Storage Usage');
                validateColumns(dataStorageRows, 'Current Data Storage Usage', ['Record Type', 'Record Count', 'Storage']);
                const topStorageObjects = dataStorageRows.map((row) => ({
                    name: getCell(row, ['Record Type']),
                    count: formatCount(toNumber(getCell(row, ['Record Count']))),
                    size: getCell(row, ['Storage'])
                })).filter((row) => row.name).slice(0, 5);

                const fileStorageRows = toRows('Current File Storage Usage');
                validateColumns(fileStorageRows, 'Current File Storage Usage', ['Record Type', 'Record Count', 'Storage']);
                const topFileStorageObjects = fileStorageRows.map((row) => ({
                    name: getCell(row, ['Record Type']),
                    count: formatCount(toNumber(getCell(row, ['Record Count']))),
                    size: getCell(row, ['Storage'])
                })).filter((row) => row.name).slice(0, 5);

                const userStorageRows = toRows('Top users by Data Storage Usage');
                validateColumns(userStorageRows, 'Top users by Data Storage Usage', ['User', 'Storage', 'Percent']);
                const userStorage = userStorageRows.map((row) => {
                    const percentRaw = toNumber(getCell(row, ['Percent']));
                    const percent = percentRaw <= 1 ? percentRaw * 100 : percentRaw;
                    return {
                        name: getCell(row, ['User']),
                        storage: getCell(row, ['Storage']),
                        percent: `${Math.round(percent)}%`
                    };
                }).filter((row) => row.name).slice(0, 5);

                const softDeletedRows = toRows('Soft Deleted Records');
                validateColumns(softDeletedRows, 'Soft Deleted Records', ['Current Storage Usage', 'Record Count', 'Deleted Counts']);
                const softDeletedRecords = softDeletedRows.map((row) => ({
                    name: getCell(row, ['Current Storage Usage']),
                    total: toNumber(getCell(row, ['Record Count'])),
                    deleted: toNumber(getCell(row, ['Deleted Counts']))
                })).filter((row) => row.name).slice(0, 3);

                const dataSkewRows = toRows('Data Skews Inventory');
                validateColumns(dataSkewRows, 'Data Skews Inventory', ['Skewed Relationship', 'Parent ID']);
                if (dataSkewRows.length) {
                    const columns = Object.keys(dataSkewRows[0] || {});
                    if (!columns.includes('Skew Size ') && !columns.includes('Skew Size')) {
                        warnings.push('Colonna mancante in Data Skews Inventory: Skew Size.');
                    }
                }
                const dataSkews = dataSkewRows.map((row) => ({
                    obj: getCell(row, ['Skewed Relationship']).split('.')[0] || getCell(row, ['Skewed Relationship']),
                    field: getCell(row, ['Skewed Relationship']).split('.')[1] || '',
                    size: toNumber(getCell(row, ['Skew Size ', 'Skew Size'])),
                    id: getCell(row, ['Parent ID'])
                })).filter((row) => row.id).slice(0, 5);

                const apexRows = toRows('Apex Classes');
                validateColumns(apexRows, 'Apex Classes', ['Name', 'Total Average Time', 'Count']);
                const slowApex = apexRows.map((row) => ({
                    name: getCell(row, ['Name']),
                    avgTime: toNumber(getCell(row, ['Total Average Time'])),
                    count: toNumber(getCell(row, ['Count']))
                })).filter((row) => row.name).slice(0, 5);
                const apexClassCount = apexRows.filter((row) => getCell(row, ['Name'])).length;

                const queriesRows = toRows('Queries');
                validateColumns(queriesRows, 'Queries', ['Unique Query Locator', 'Average Query Time', 'Max Query Time', 'Count']);
                const queries = queriesRows.map((row) => ({
                    name: getCell(row, ['Unique Query Locator']),
                    avgTime: toNumber(getCell(row, ['Average Query Time'])),
                    maxTime: toNumber(getCell(row, ['Max Query Time'])),
                    count: toNumber(getCell(row, ['Count']))
                })).filter((row) => row.name).slice(0, 5);

                const apiRows = toRows('API Versions');
                validateColumns(apiRows, 'API Versions', ['ApiVersion']);
                const apiVersions = apiRows.map((row) => toNumber(getCell(row, ['ApiVersion']))).filter((val) => val > 0);
                const apiVersionRange = apiVersions.length ? `${Math.min(...apiVersions)} - ${Math.max(...apiVersions)}` : '';

                return {
                    storageData,
                    codeQualityData,
                    codeQualityRules,
                    topIssuesFiles,
                    topStorageObjects,
                    topFileStorageObjects,
                    softDeletedRecords,
                    slowApex,
                    dataSkews,
                    userStorage,
                    queries,
                    apexClassCount,
                    apiVersionRange,
                    warnings
                };
            };

            const handleFileUpload = (event) => {
                const file = event.target.files?.[0];
                if (!file) return;
                setLoadError('');
                setWarnings([]);
                setFileName(file.name);
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const dataBuffer = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(dataBuffer, { type: 'array' });
                        const parsed = parseWorkbook(workbook);
                        const { warnings: parsedWarnings, ...parsedData } = parsed;
                        setData(parsedData);
                        setWarnings(parsedWarnings || []);
                        const dateStr = new Date().toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: '2-digit' }).replace(/\s/g, ' ');
                        setLastUpdated(`Ultimo aggiornamento: ${dateStr}`);
                    } catch (error) {
                        setLoadError('Errore durante la lettura del file Excel. Verifica il formato.');
                    }
                };
                reader.onerror = () => setLoadError('Errore durante la lettura del file Excel.');
                reader.readAsArrayBuffer(file);
            };

            const renderContent = () => {
                switch(activeTab) {
                    case 'overview': return <OverviewTab storageData={data.storageData} codeQualityData={data.codeQualityData} topStorageObjects={data.topStorageObjects} userStorage={data.userStorage} apexClassCount={data.apexClassCount} apiVersionRange={data.apiVersionRange} />;
                    case 'quality': return <QualityTab codeQualityData={data.codeQualityData} topIssuesFiles={data.topIssuesFiles} codeQualityRules={data.codeQualityRules} />;
                    case 'storage': return <StorageTab topStorageObjects={data.topStorageObjects} topFileStorageObjects={data.topFileStorageObjects} userStorage={data.userStorage} softDeletedRecords={data.softDeletedRecords} />;
                    case 'performance': return <PerformanceTab slowApex={data.slowApex} dataSkews={data.dataSkews} queries={data.queries} />;
                    case 'inventory': return <InventoryTab />;
                    default: return <OverviewTab storageData={data.storageData} codeQualityData={data.codeQualityData} topStorageObjects={data.topStorageObjects} userStorage={data.userStorage} apexClassCount={data.apexClassCount} apiVersionRange={data.apiVersionRange} />;
                }
            };

            return (
                <div className="min-h-screen bg-slate-100 flex">
                    {/* Sidebar */}
                    <Sidebar 
                        activeTab={activeTab} 
                        setActiveTab={setActiveTab} 
                        isOpen={isSidebarOpen}
                        setIsOpen={setIsSidebarOpen}
                    />

                    {/* Main Content */}
                    <div className="flex-1 lg:ml-64 flex flex-col min-h-screen">
                        {/* Header Mobile */}
                        <div className="lg:hidden bg-white shadow-sm p-4 flex items-center justify-between sticky top-0 z-10">
                            <h1 className="font-bold text-slate-800">Enel Global Services</h1>
                            <div className="flex items-center gap-3">
                                <label className="flex items-center gap-2 text-xs text-slate-600 cursor-pointer">
                                    <input type="file" accept=".xlsx,.xls" className="hidden" onChange={handleFileUpload} />
                                    <span className="px-2 py-1 bg-slate-100 rounded-md font-medium">Carica</span>
                                </label>
                                <button onClick={() => setIsSidebarOpen(true)} className="p-2 text-slate-600">
                                    <Menu />
                                </button>
                            </div>
                        </div>

                        {/* Top Bar Desktop */}
                        <header className="hidden lg:flex bg-white shadow-sm py-4 px-8 justify-between items-center sticky top-0 z-10">
                            <h2 className="text-xl font-bold text-slate-800">
                                {activeTab === 'overview' && 'Panoramica Sistema'}
                                {activeTab === 'quality' && 'Analisi Qualità Codice'}
                                {activeTab === 'storage' && 'Analisi Storage & Utilizzo'}
                                {activeTab === 'performance' && 'Metriche Performance'}
                                {activeTab === 'inventory' && 'Inventario Oggetti & Metadati'}
                            </h2>
                            <div className="flex items-center space-x-4">
                                <label className="flex items-center gap-2 text-sm text-slate-600 cursor-pointer">
                                    <input type="file" accept=".xlsx,.xls" className="hidden" onChange={handleFileUpload} />
                                    <span className="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 rounded-lg font-medium">Carica Excel</span>
                                    <span className="text-xs text-slate-400">{fileName || 'Nessun file'}</span>
                                </label>
                                <span className="text-sm text-slate-500">{lastUpdated}</span>
                                <div className="h-8 w-8 bg-blue-600 rounded-full text-white flex items-center justify-center font-bold text-sm">
                                    EG
                                </div>
                            </div>
                        </header>

                        {/* Content Scroll Area */}
                        <main className="flex-1 p-6 overflow-y-auto">
                            <div className="max-w-7xl mx-auto">
                                {loadError && (
                                    <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-sm text-red-700 mb-6">
                                        {loadError}
                                    </div>
                                )}
                                {warnings.length > 0 && (
                                    <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 text-sm text-amber-800 mb-6">
                                        <p className="font-semibold mb-2">Attenzione: alcuni dati potrebbero mancare</p>
                                        <ul className="list-disc list-inside space-y-1">
                                            {warnings.map((warning, idx) => (
                                                <li key={idx}>{warning}</li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                                {!data.storageData.length && (
                                    <div className="bg-white border border-slate-200 rounded-lg p-6 text-sm text-slate-600 mb-6">
                                        Carica un file Excel per visualizzare i dati reali del dashboard.
                                    </div>
                                )}
                                {renderContent()}
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
